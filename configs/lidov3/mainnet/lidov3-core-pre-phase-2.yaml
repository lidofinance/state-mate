# yaml-language-server: $schema=../../schemas/main-schema.json

#
# Lido V3 Phase 2 - Pre-Vote Configuration
#
# This configuration represents the state BEFORE the Phase 2 vote is enacted.
# Phase 2 enables the Predeposit Guarantee on mainnet and increases the global
# stVaults minting limit to ~3M ETH via a 30% max external ratio.
#
# Key differences from post-phase-2:
# - Max external ratio: 300 BP (3%) - Phase 1 value
# - PDG implementation: Phase 1 implementation (paused)
# - Old Easy Track factories for vaults operations
# - Old VaultsAdapter
#

---
parameters:
  - &contract4788 "0x000F3df6D732807Ef1319fB7B8bB8522d0Beac02"
  - &contractDeposit "0x00000000219ab540356cBB839Cbe05303d7705Fa"

deployed:
  l1:
    # --- Core protocol ---
    - &lidoLocator "0xC1d0b3DE6792Bf6b4b37EccdcC24e45978Cfd2Eb"
    - &lidoLocatorImplAddress "0x2f8779042EFaEd4c53db2Ce293eB6B3f7096C72d"
    - &lido "0xae7ab96520DE3A18E5e111B5EaAb095312D7fE84"
    - &lidoImplAddress "0x6ca84080381E43938476814be61B779A8bB6a600"
    - &wstETH "0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0"
    - &stakingRouter "0xFdDf38947aFB03C621C71b06C9C70bce73f12999"
    - &stakingRouterImplAddress "0x226f9265CBC37231882b7409658C18bB7738173A"
    - &accounting "0x23ED611be0e1a820978875C0122F92260804cdDf"
    - &accountingImplAddress "0xd43a3E984071F40d5d840f60708Af0e9526785df"
    - &burner "0xE76c52750019b80B43E36DF30bf4060EB73F573a"
    - &burnerImplAddress "0xEe1E3B4f047122650086985f794f0dB5f10Ae49D"

    # --- stVaults system contracts ---
    - &vaultHub "0x1d201BE093d847f6446530Efb0E8Fb426d176709"
    - &vaultHubImplAddress "0x7c7d957D0752AB732E73400624C4a1eb1cb6CF50"
    - &predepositGuarantee "0xF4bF42c6D6A0E38825785048124DBAD6c9eaaac3"
    - &predepositGuaranteeImplAddress "0xCC08C36BD5bb78FDcB10F35B404ada6Ffc71a023" # Phase 1 implementation
    - &operatorGrid "0xC69685E89Cefc327b43B7234AC646451B27c544d"
    - &operatorGridImplAddress "0xA612E30D71d7D54aEaf4e5A21023F3F270932C2C"

    # --- stVaults factory stack ---
    - &stakingVaultFactory "0x02Ca7772FF14a9F6c1a08aF385aA96bb1b34175A"
    - &stakingVaultBeacon "0x5FbE8cEf9CCc56ad245736D3C5bAf82ad54Ca789"
    - &stakingVaultImplAddress "0x06A56487494aa080deC7Bf69128EdA9225784553"
    - &dashboardImplAddress "0x294825c2764c7D412dc32d87E2242c4f1D989AF3"

    # --- Oracle contracts ---
    - &accountingOracle "0x852deD011285fe67063a08005c71a85690503Cee"
    - &accountingOracleImplAddress "0x1455B96780A93e08abFE41243Db92E2fCbb0141c"
    - &hashConsensusForAccountingOracle "0xD624B08C83bAECF0807Dd2c6880C3154a5F0B288"
    - &validatorsExitBusOracle "0x0De4Ea0184c2ad0BacA7183356Aea5B8d5Bf5c6e"
    - &oracleReportSanityChecker "0xf1647c86E6D7959f638DD9CE1d90e2F3C9503129"

    # --- DAO & Aragon apps ---
    - &aragonAgent "0x3e40D73EB977Dc6a537aF587D48316feE66E9C8c"
    - &ldo "0x5A98FcBEA516Cf06857215779Fd812CA3beF1B32"

    # --- Easy Track - Phase 1 factories (OLD) ---
    - &easyTrack "0xF0211b7660680B49De1A7E9f25C65660F0a13Fea"
    - &evmScriptExecutor "0xFE5986E06210aC1eCC1aDCafc0cc7f8D63B3F977"
    - &vaultsAdapter "0xe2DE6d2DefF15588a71849c0429101F8ca9FB14D" # Phase 1 VaultsAdapter
    - &etfAlterTiersInOperatorGrid "0xa29173C7BCf39dA48D5E404146A652d7464aee14"
    - &etfForceValidatorExitsInVaultHub "0x6C968cD89CA358fbAf57B18e77a8973Fa869a6aA"
    - &etfRegisterGroupsInOperatorGrid "0x194A46DA1947E98c9D79af13E06Cfbee0D8610cC"
    - &etfRegisterTiersInOperatorGrid "0x5292A1284e4695B95C0840CF8ea25A818751C17F"
    - &etfSetJailStatusInOperatorGrid "0x93F1DEE4473Ee9F42c8257C201e33a6Da30E5d67"
    - &etfSocializeBadDebtInVaultHub "0x1dF50522A1D868C12bF71747Bb6F24A18Fe6d32C"
    - &etfUpdateGroupsShareLimitInOperatorGrid "0x8Bdc726a3147D8187820391D7c6F9F942606aEe6"
    - &etfUpdateVaultsFeesInOperatorGrid "0x5C3bDFa3E7f312d8cf72F56F2b797b026f6B471c"

    # --- GateSeal ---
    - &gateSealVaulthubAndPredepositGuarantee "0x881dAd714679A6FeaA636446A0499101375A365c"

    # --- Committees (Safe msigs) ---
    - &resealManager "0x7914b5a1539b97Bd0bbd155757F25FD79A522d24"

    # --- CSM ---
    - &CSModule "0xdA7dE2ECdDfccC6c3AF10108Db212ACBBf9EA83F"

misc:
  # --- Chain and deployment constants ---
  - &CHAIN_ID "1"

  # --- Addresses / Zero values ---
  - &ZERO_ADDRESS "0x0000000000000000000000000000000000000000"
  - &ZERO_BYTES32 "0x0000000000000000000000000000000000000000000000000000000000000000"
  - &DEFAULT_ADMIN_ROLE "0x0000000000000000000000000000000000000000000000000000000000000000"

  # --- General numeric constants ---
  - &MAX_UINT256 "115792089237316195423570985008687907853269984665640564039457584007913129639935"
  - &ONE_ETH_WEI 1000000000000000000

  # --- Protocol configuration - Phase 1 values ---
  - &LIDO_MAX_EXTERNAL_RATIO_BP 300 # 3% cap - Phase 1 value, will be 3000 (30%) after Phase 2

  # --- stVaults tier defaults ---
  - &DEFAULT_TIER_ID 0
  - &DEFAULT_TIER_OPERATOR "0xFFfFfFffFFfffFFfFFfFFFFFffFFFffffFfFFFfF"
  - &DEFAULT_TIER_RR 5000
  - &DEFAULT_TIER_SHARE_LIMIT 0
  - &DEFAULT_TIER_SHARE_FRT 4975
  - &DEFAULT_TIER_INFRA_FEE 100
  - &DEFAULT_TIER_LIQUIDITY_FEE 650
  - &DEFAULT_TIER_RESERVATION_FEE 0
  - &MAX_RELATIVE_SHARE_LIMIT_BP 1000
  - &REPORT_FRESHNESS_DELTA 172800

  # --- Time durations (in seconds) ---
  - &DURATION_1_HOUR 3600
  - &DURATION_30_DAYS 2592000

  # --- Beacon spec constants ---
  - &GENESIS_TIME "1606824023"
  - &ACTIVATION_DEPOSIT_AMOUNT 31000000000000000000
  - &MAX_TOPUP_AMOUNT 2016000000000000000000
  - &DEPOSIT_DOMAIN "0x03000000f5a5fd42d16a20302798ef6ed309979b43003d2320d9f0e8ea9831a9"
  - &GI_FIRST_VALIDATOR_CURR "0x0000000000000000000000000000000000000000000000000096000000000028"
  - &GI_PUBKEY_WC_PARENT "0x0000000000000000000000000000000000000000000000000000000000000402"
  - &GI_STATE_ROOT "0x0000000000000000000000000000000000000000000000000000000000000b03"

roles:
  # VaultHub
  - &VAULT_MASTER_ROLE "0x479bc4a51d27fbdc8e51b5b1ebd3dcd58bd229090980bff226f8930587e69ce3"
  - &BAD_DEBT_MASTER_ROLE "0xa85bab4b576ca359fa6ae02ab8744b5c85c7e7ed4d7e0bca7b5b64580ac5d17d"
  - &REDEMPTION_MASTER_ROLE "0x44f007e8cc2a08047a03d8d9c295057454942eb49ee3ced9c87e9b9406f21174"
  - &VALIDATOR_EXIT_ROLE "0x2159c5943234d9f3a7225b9a743ea06e4a0d0ba5ed82889e867759a8a9eb7883"

  # OZ
  - &OZ_PAUSE_ROLE "0x8d0e4ae4847b49935b55c99f9c3ce025c87e7c4604c35b7ae56929bd32fa5a78"
  - &OZ_RESUME_ROLE "0xa79a6aede309e0d48bf2ef0f71355c06ad317956d4c0da2deb0dc47cc34f826c"

  # OperatorGrid
  - &REGISTRY_ROLE "0xa495a3428837724c7f7648cda02eb83c9c4c778c8688d6f254c7f3f80c154d55"

l1:
  rpcUrl: REMOTE_RPC_URL
  explorerHostname: api.etherscan.io
  explorerTokenEnv: ETHERSCAN_TOKEN
  chainId: *CHAIN_ID
  contracts:
    # --- Core Lido contract - Phase 1 max external ratio ---
    lido:
      name: Lido
      address: *lido
      proxyName: AppProxyUpgradeable
      implementation: *lidoImplAddress
      checks:
        getMaxExternalRatioBP: *LIDO_MAX_EXTERNAL_RATIO_BP # 300 BP (3%) - Phase 1 value

    # --- VaultHub - Phase 1 state ---
    vaultHub:
      name: VaultHub
      address: *vaultHub
      proxyName: OssifiableProxy
      implementation: *vaultHubImplAddress
      proxyChecks:
        proxy__getAdmin: *aragonAgent
        proxy__getImplementation: *vaultHubImplAddress
        proxy__getIsOssified: false
      checks:
        CONNECT_DEPOSIT: *ONE_ETH_WEI
        CONSENSUS_CONTRACT: *hashConsensusForAccountingOracle
        MAX_RELATIVE_SHARE_LIMIT_BP: *MAX_RELATIVE_SHARE_LIMIT_BP
        REPORT_FRESHNESS_DELTA: *REPORT_FRESHNESS_DELTA
        LIDO: *lido
        LIDO_LOCATOR: *lidoLocator
        PAUSE_INFINITELY: *MAX_UINT256
        DEFAULT_ADMIN_ROLE: *ZERO_BYTES32
        PAUSE_ROLE: *OZ_PAUSE_ROLE
        RESUME_ROLE: *OZ_RESUME_ROLE
        VAULT_MASTER_ROLE: *VAULT_MASTER_ROLE
        BAD_DEBT_MASTER_ROLE: *BAD_DEBT_MASTER_ROLE
        REDEMPTION_MASTER_ROLE: *REDEMPTION_MASTER_ROLE
        VALIDATOR_EXIT_ROLE: *VALIDATOR_EXIT_ROLE
        getResumeSinceTimestamp: 0
        isPaused: false
      ozAcl:
        *DEFAULT_ADMIN_ROLE : [*aragonAgent]
        *OZ_PAUSE_ROLE : [*gateSealVaulthubAndPredepositGuarantee, *resealManager]
        *OZ_RESUME_ROLE : [*resealManager]
        *VAULT_MASTER_ROLE : []
        *BAD_DEBT_MASTER_ROLE : [*vaultsAdapter]
        *REDEMPTION_MASTER_ROLE : []
        *VALIDATOR_EXIT_ROLE : [*vaultsAdapter]

    # --- PredepositGuarantee - Phase 1 implementation (paused) ---
    predepositGuarantee:
      name: PredepositGuarantee
      address: *predepositGuarantee
      proxyName: OssifiableProxy
      implementation: *predepositGuaranteeImplAddress # Phase 1 implementation
      proxyChecks:
        proxy__getAdmin: *aragonAgent
        proxy__getImplementation: *predepositGuaranteeImplAddress
        proxy__getIsOssified: false
      checks:
        PREDEPOSIT_AMOUNT: *ONE_ETH_WEI
        ACTIVATION_DEPOSIT_AMOUNT: *ACTIVATION_DEPOSIT_AMOUNT
        MAX_TOPUP_AMOUNT: *MAX_TOPUP_AMOUNT
        BEACON_ROOTS: *contract4788
        DEFAULT_ADMIN_ROLE: *ZERO_BYTES32
        DEPOSIT_DOMAIN: *DEPOSIT_DOMAIN
        GI_FIRST_VALIDATOR_CURR: *GI_FIRST_VALIDATOR_CURR
        GI_FIRST_VALIDATOR_PREV: *GI_FIRST_VALIDATOR_CURR
        GI_PUBKEY_WC_PARENT: *GI_PUBKEY_WC_PARENT
        GI_STATE_ROOT: *GI_STATE_ROOT
        MIN_SUPPORTED_WC_VERSION: 1
        MAX_SUPPORTED_WC_VERSION: 2
        PIVOT_SLOT: 0
        PAUSE_INFINITELY: *MAX_UINT256
        PAUSE_ROLE: *OZ_PAUSE_ROLE
        RESUME_ROLE: *OZ_RESUME_ROLE
        getResumeSinceTimestamp: *MAX_UINT256 # PAUSE_INFINITELY - paused in Phase 1
        isPaused: true # Paused in Phase 1
      ozAcl:
        *DEFAULT_ADMIN_ROLE : [*aragonAgent]
        *OZ_PAUSE_ROLE : [*gateSealVaulthubAndPredepositGuarantee, *resealManager]
        *OZ_RESUME_ROLE : [*resealManager]

    # --- OperatorGrid ---
    operatorGrid:
      name: OperatorGrid
      address: *operatorGrid
      proxyName: OssifiableProxy
      implementation: *operatorGridImplAddress
      proxyChecks:
        proxy__getAdmin: *aragonAgent
        proxy__getImplementation: *operatorGridImplAddress
        proxy__getIsOssified: false
      checks:
        DEFAULT_ADMIN_ROLE: *ZERO_BYTES32
        DEFAULT_TIER_ID: *DEFAULT_TIER_ID
        DEFAULT_TIER_OPERATOR: *DEFAULT_TIER_OPERATOR
        LIDO_LOCATOR: *lidoLocator
        REGISTRY_ROLE: *REGISTRY_ROLE
        MAX_CONFIRM_EXPIRY: *DURATION_30_DAYS
        MIN_CONFIRM_EXPIRY: *DURATION_1_HOUR
        tier:
          - args: [*DEFAULT_TIER_ID]
            result:
              [
                *DEFAULT_TIER_OPERATOR,
                *DEFAULT_TIER_SHARE_LIMIT,
                0,
                *DEFAULT_TIER_RR,
                *DEFAULT_TIER_SHARE_FRT,
                *DEFAULT_TIER_INFRA_FEE,
                *DEFAULT_TIER_LIQUIDITY_FEE,
                *DEFAULT_TIER_RESERVATION_FEE,
              ]
      ozAcl:
        *DEFAULT_ADMIN_ROLE : [*aragonAgent]
        *REGISTRY_ROLE : [*evmScriptExecutor, *vaultsAdapter]

    # --- VaultsAdapter - Phase 1 ---
    vaultsAdapter:
      name: VaultsAdapter
      address: *vaultsAdapter # Phase 1 VaultsAdapter
      checks:
        evmScriptExecutor: *evmScriptExecutor
        lidoLocator: *lidoLocator
