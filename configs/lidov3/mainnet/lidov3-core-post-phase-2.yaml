# yaml-language-server: $schema=../../schemas/main-schema.json

#
# Lido V3 Phase 2 - Post-Vote Configuration
#
# This configuration represents the state AFTER the Phase 2 vote is enacted.
# Phase 2 enables the Predeposit Guarantee on mainnet and increases the global
# stVaults minting limit to ~3M ETH via a 30% max external ratio.
#
# Key changes from Phase 1:
# - Max external ratio: 3000 BP (30%) - enabling ~3M ETH global minting capacity
# - New PDG implementation: 0xE78717192C45736DF0E4be55c0219Ee7f9aDdd0D (unpaused)
# - New VaultsAdapter: 0x28F9Ac198C4E0FA6A9Ad2c2f97CB38F1A3120f27
# - New Easy Track factories for vaults operations
#
# Voting: January 20, 2026
# Expected enactment: ~January 29, 2026
#

---
parameters:
  - &contract4788 "0x000F3df6D732807Ef1319fB7B8bB8522d0Beac02"
  - &contractDeposit "0x00000000219ab540356cBB839Cbe05303d7705Fa"

deployed:
  l1:
    # --- Core protocol ---
    - &lidoLocator "0xC1d0b3DE6792Bf6b4b37EccdcC24e45978Cfd2Eb"
    - &lidoLocatorImplAddress "0x2f8779042EFaEd4c53db2Ce293eB6B3f7096C72d"
    - &lido "0xae7ab96520DE3A18E5e111B5EaAb095312D7fE84"
    - &lidoImplAddress "0x6ca84080381E43938476814be61B779A8bB6a600"
    - &wstETH "0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0"
    - &stakingRouter "0xFdDf38947aFB03C621C71b06C9C70bce73f12999"
    - &stakingRouterImplAddress "0x226f9265CBC37231882b7409658C18bB7738173A"
    - &accounting "0x23ED611be0e1a820978875C0122F92260804cdDf"
    - &accountingImplAddress "0xd43a3E984071F40d5d840f60708Af0e9526785df"
    - &burner "0xE76c52750019b80B43E36DF30bf4060EB73F573a"
    - &burnerImplAddress "0xEe1E3B4f047122650086985f794f0dB5f10Ae49D"

    # --- stVaults system contracts ---
    - &vaultHub "0x1d201BE093d847f6446530Efb0E8Fb426d176709"
    - &vaultHubImplAddress "0x7c7d957D0752AB732E73400624C4a1eb1cb6CF50"
    - &predepositGuarantee "0xF4bF42c6D6A0E38825785048124DBAD6c9eaaac3"
    - &predepositGuaranteeImplAddress "0xE78717192C45736DF0E4be55c0219Ee7f9aDdd0D" # NEW Phase 2 implementation
    - &operatorGrid "0xC69685E89Cefc327b43B7234AC646451B27c544d"
    - &operatorGridImplAddress "0xA612E30D71d7D54aEaf4e5A21023F3F270932C2C"

    # --- stVaults factory stack ---
    - &stakingVaultFactory "0x02Ca7772FF14a9F6c1a08aF385aA96bb1b34175A"
    - &stakingVaultBeacon "0x5FbE8cEf9CCc56ad245736D3C5bAf82ad54Ca789"
    - &stakingVaultImplAddress "0x06A56487494aa080deC7Bf69128EdA9225784553"
    - &dashboardImplAddress "0x294825c2764c7D412dc32d87E2242c4f1D989AF3"

    # --- Oracle contracts ---
    - &accountingOracle "0x852deD011285fe67063a08005c71a85690503Cee"
    - &accountingOracleImplAddress "0x1455B96780A93e08abFE41243Db92E2fCbb0141c"
    - &hashConsensusForAccountingOracle "0xD624B08C83bAECF0807Dd2c6880C3154a5F0B288"
    - &validatorsExitBusOracle "0x0De4Ea0184c2ad0BacA7183356Aea5B8d5Bf5c6e"
    - &oracleReportSanityChecker "0xf1647c86E6D7959f638DD9CE1d90e2F3C9503129"

    # --- DAO & Aragon apps ---
    - &aragonAgent "0x3e40D73EB977Dc6a537aF587D48316feE66E9C8c"
    - &ldo "0x5A98FcBEA516Cf06857215779Fd812CA3beF1B32"

    # --- Easy Track - Phase 2 factories (NEW) ---
    - &easyTrack "0xF0211b7660680B49De1A7E9f25C65660F0a13Fea"
    - &evmScriptExecutor "0xFE5986E06210aC1eCC1aDCafc0cc7f8D63B3F977"
    - &vaultsAdapter "0x28F9Ac198C4E0FA6A9Ad2c2f97CB38F1A3120f27" # NEW Phase 2 VaultsAdapter
    - &etfAlterTiersInOperatorGrid "0x73f80240ad9363d5d3C5C3626953C351cA36Bfe9" # NEW
    - &etfForceValidatorExitsInVaultHub "0x6F5c0A5a824773E8f8285bC5aA59ea0Aab2A6400" # NEW
    - &etfRegisterGroupsInOperatorGrid "0xE73842AEbEC99Dacf2aAEec61409fD01A033f478" # NEW
    - &etfRegisterTiersInOperatorGrid "0x5292A1284e4695B95C0840CF8ea25A818751C17F" # Unchanged
    - &etfSetJailStatusInOperatorGrid "0x6a4f33F05E7412A11100353724Bb6a152Cf0D305" # NEW
    - &etfSocializeBadDebtInVaultHub "0xaf35A63a4114B7481589fDD9FDB3e35Fd65fAed7" # NEW
    - &etfUpdateGroupsShareLimitInOperatorGrid "0xf23559De8ab37fF7a154384B0822dA867Cfa7Eac" # NEW
    - &etfUpdateVaultsFeesInOperatorGrid "0xDfA0bc38113B6d53c2881573FD764CEEFf468610" # NEW
    - &etfSetLiabilitySharesTargetInVaultHub "0x647DeE7bF33e44829e6430F7A08F63b3319694f0" # NEW

    # --- GateSeal ---
    - &gateSealVaulthubAndPredepositGuarantee "0x881dAd714679A6FeaA636446A0499101375A365c"

    # --- Committees (Safe msigs) ---
    - &resealManager "0x7914b5a1539b97Bd0bbd155757F25FD79A522d24"
    - &stVaultsCommittee "0x18A1065c81b0Cc356F1b1C843ddd5E14e4AefffF" # stVaults Committee

    # --- CSM ---
    - &CSModule "0xdA7dE2ECdDfccC6c3AF10108Db212ACBBf9EA83F"

misc:
  # --- Chain and deployment constants ---
  - &CHAIN_ID "1"

  # --- Addresses / Zero values ---
  - &ZERO_ADDRESS "0x0000000000000000000000000000000000000000"
  - &ZERO_BYTES32 "0x0000000000000000000000000000000000000000000000000000000000000000"
  - &DEFAULT_ADMIN_ROLE "0x0000000000000000000000000000000000000000000000000000000000000000"
  - &withdrawalRequestPredeployAddress "0x00000961Ef480Eb55e80D19ad83579A64c007002"

  # --- General numeric constants ---
  - &MAX_UINT256 "115792089237316195423570985008687907853269984665640564039457584007913129639935"
  - &ONE_ETH_WEI 1000000000000000000

  # --- Protocol configuration - Phase 2 values ---
  - &LIDO_MAX_EXTERNAL_RATIO_BP 3000 # 30% cap - Phase 2 value, enabling ~3M ETH minting capacity

  # --- stVaults tier defaults ---
  - &DEFAULT_TIER_ID 0
  - &DEFAULT_TIER_OPERATOR "0xFFfFfFffFFfffFFfFFfFFFFFffFFFffffFfFFFfF"
  - &DEFAULT_TIER_RR 5000
  - &DEFAULT_TIER_SHARE_LIMIT 0
  - &DEFAULT_TIER_SHARE_FRT 4975
  - &DEFAULT_TIER_INFRA_FEE 100
  - &DEFAULT_TIER_LIQUIDITY_FEE 650
  - &DEFAULT_TIER_RESERVATION_FEE 0
  - &MAX_RELATIVE_SHARE_LIMIT_BP 1000
  - &REPORT_FRESHNESS_DELTA 172800

  # --- VaultsAdapter limits ---
  - &VAULTS_ADAPTER_LIMIT "1000000000000000000000000" # 1,000,000e18

  # --- Time durations (in seconds) ---
  - &DURATION_1_HOUR 3600
  - &DURATION_30_DAYS 2592000

  # --- Beacon spec constants ---
  - &GENESIS_TIME "1606824023"
  - &ACTIVATION_DEPOSIT_AMOUNT 31000000000000000000
  - &MAX_TOPUP_AMOUNT 2016000000000000000000
  - &DEPOSIT_DOMAIN "0x03000000f5a5fd42d16a20302798ef6ed309979b43003d2320d9f0e8ea9831a9"
  - &GI_FIRST_VALIDATOR_CURR "0x0000000000000000000000000000000000000000000000000096000000000028"
  - &GI_PUBKEY_WC_PARENT "0x0000000000000000000000000000000000000000000000000000000000000402"
  - &GI_STATE_ROOT "0x0000000000000000000000000000000000000000000000000000000000000b03"

roles:
  # VaultHub
  - &VAULT_MASTER_ROLE "0x479bc4a51d27fbdc8e51b5b1ebd3dcd58bd229090980bff226f8930587e69ce3"
  - &BAD_DEBT_MASTER_ROLE "0xa85bab4b576ca359fa6ae02ab8744b5c85c7e7ed4d7e0bca7b5b64580ac5d17d"
  - &REDEMPTION_MASTER_ROLE "0x44f007e8cc2a08047a03d8d9c295057454942eb49ee3ced9c87e9b9406f21174"
  - &VALIDATOR_EXIT_ROLE "0x2159c5943234d9f3a7225b9a743ea06e4a0d0ba5ed82889e867759a8a9eb7883"

  # OZ
  - &OZ_PAUSE_ROLE "0x8d0e4ae4847b49935b55c99f9c3ce025c87e7c4604c35b7ae56929bd32fa5a78"
  - &OZ_RESUME_ROLE "0xa79a6aede309e0d48bf2ef0f71355c06ad317956d4c0da2deb0dc47cc34f826c"

  # OperatorGrid
  - &REGISTRY_ROLE "0xa495a3428837724c7f7648cda02eb83c9c4c778c8688d6f254c7f3f80c154d55"

l1:
  rpcUrl: REMOTE_RPC_URL
  explorerHostname: api.etherscan.io
  explorerTokenEnv: ETHERSCAN_TOKEN
  chainId: *CHAIN_ID
  contracts:
    # --- Core Lido contract - Phase 2 max external ratio ---
    lido:
      name: Lido
      address: *lido
      proxyName: AppProxyUpgradeable
      implementation: *lidoImplAddress
      checks:
        getMaxExternalRatioBP: *LIDO_MAX_EXTERNAL_RATIO_BP # 3000 BP (30%) - Phase 2 value

    # --- VaultHub - Phase 2 state with new VaultsAdapter ---
    vaultHub:
      name: VaultHub
      address: *vaultHub
      proxyName: OssifiableProxy
      implementation: *vaultHubImplAddress
      proxyChecks:
        proxy__getAdmin: *aragonAgent
        proxy__getImplementation: *vaultHubImplAddress
        proxy__getIsOssified: false
      checks:
        CONNECT_DEPOSIT: *ONE_ETH_WEI
        CONSENSUS_CONTRACT: *hashConsensusForAccountingOracle
        MAX_RELATIVE_SHARE_LIMIT_BP: *MAX_RELATIVE_SHARE_LIMIT_BP
        REPORT_FRESHNESS_DELTA: *REPORT_FRESHNESS_DELTA
        LIDO: *lido
        LIDO_LOCATOR: *lidoLocator
        PAUSE_INFINITELY: *MAX_UINT256
        DEFAULT_ADMIN_ROLE: *ZERO_BYTES32
        PAUSE_ROLE: *OZ_PAUSE_ROLE
        RESUME_ROLE: *OZ_RESUME_ROLE
        VAULT_MASTER_ROLE: *VAULT_MASTER_ROLE
        BAD_DEBT_MASTER_ROLE: *BAD_DEBT_MASTER_ROLE
        REDEMPTION_MASTER_ROLE: *REDEMPTION_MASTER_ROLE
        VALIDATOR_EXIT_ROLE: *VALIDATOR_EXIT_ROLE
        getResumeSinceTimestamp: 0
        isPaused: false
      ozAcl:
        *DEFAULT_ADMIN_ROLE : [*aragonAgent]
        *OZ_PAUSE_ROLE : [*gateSealVaulthubAndPredepositGuarantee, *resealManager]
        *OZ_RESUME_ROLE : [*resealManager]
        *VAULT_MASTER_ROLE : []
        *BAD_DEBT_MASTER_ROLE : [*vaultsAdapter] # NEW VaultsAdapter
        *REDEMPTION_MASTER_ROLE : []
        *VALIDATOR_EXIT_ROLE : [*vaultsAdapter] # NEW VaultsAdapter

    # --- PredepositGuarantee - Phase 2 implementation (unpaused) ---
    predepositGuarantee:
      name: PredepositGuarantee
      address: *predepositGuarantee
      proxyName: OssifiableProxy
      implementation: *predepositGuaranteeImplAddress # NEW Phase 2 implementation
      proxyChecks:
        proxy__getAdmin: *aragonAgent
        proxy__getImplementation: *predepositGuaranteeImplAddress
        proxy__getIsOssified: false
      checks:
        PREDEPOSIT_AMOUNT: *ONE_ETH_WEI
        ACTIVATION_DEPOSIT_AMOUNT: *ACTIVATION_DEPOSIT_AMOUNT
        MAX_TOPUP_AMOUNT: *MAX_TOPUP_AMOUNT
        BEACON_ROOTS: *contract4788
        DEFAULT_ADMIN_ROLE: *ZERO_BYTES32
        DEPOSIT_DOMAIN: *DEPOSIT_DOMAIN
        GI_FIRST_VALIDATOR_CURR: *GI_FIRST_VALIDATOR_CURR
        GI_FIRST_VALIDATOR_PREV: *GI_FIRST_VALIDATOR_CURR
        GI_PUBKEY_WC_PARENT: *GI_PUBKEY_WC_PARENT
        GI_STATE_ROOT: *GI_STATE_ROOT
        MIN_SUPPORTED_WC_VERSION: 1
        MAX_SUPPORTED_WC_VERSION: 2
        PIVOT_SLOT: 0
        PAUSE_INFINITELY: *MAX_UINT256
        PAUSE_ROLE: *OZ_PAUSE_ROLE
        RESUME_ROLE: *OZ_RESUME_ROLE
        getResumeSinceTimestamp: 0 # Unpaused in Phase 2
        isPaused: false # Unpaused in Phase 2
      ozAcl:
        *DEFAULT_ADMIN_ROLE : [*aragonAgent]
        *OZ_PAUSE_ROLE : [*gateSealVaulthubAndPredepositGuarantee, *resealManager]
        *OZ_RESUME_ROLE : [*resealManager]

    # --- OperatorGrid ---
    operatorGrid:
      name: OperatorGrid
      address: *operatorGrid
      proxyName: OssifiableProxy
      implementation: *operatorGridImplAddress
      proxyChecks:
        proxy__getAdmin: *aragonAgent
        proxy__getImplementation: *operatorGridImplAddress
        proxy__getIsOssified: false
      checks:
        DEFAULT_ADMIN_ROLE: *ZERO_BYTES32
        DEFAULT_TIER_ID: *DEFAULT_TIER_ID
        DEFAULT_TIER_OPERATOR: *DEFAULT_TIER_OPERATOR
        LIDO_LOCATOR: *lidoLocator
        REGISTRY_ROLE: *REGISTRY_ROLE
        MAX_CONFIRM_EXPIRY: *DURATION_30_DAYS
        MIN_CONFIRM_EXPIRY: *DURATION_1_HOUR
        tier:
          - args: [*DEFAULT_TIER_ID]
            result:
              [
                *DEFAULT_TIER_OPERATOR,
                *DEFAULT_TIER_SHARE_LIMIT,
                0,
                *DEFAULT_TIER_RR,
                *DEFAULT_TIER_SHARE_FRT,
                *DEFAULT_TIER_INFRA_FEE,
                *DEFAULT_TIER_LIQUIDITY_FEE,
                *DEFAULT_TIER_RESERVATION_FEE,
              ]
      ozAcl:
        *DEFAULT_ADMIN_ROLE : [*aragonAgent]
        *REGISTRY_ROLE : [*evmScriptExecutor, *vaultsAdapter] # NEW VaultsAdapter

    # --- VaultsAdapter - Phase 2 (NEW) ---
    vaultsAdapter:
      name: VaultsAdapter
      address: *vaultsAdapter # NEW Phase 2 VaultsAdapter
      checks:
        WITHDRAWAL_REQUEST_PREDEPLOY_ADDRESS: *withdrawalRequestPredeployAddress
        evmScriptExecutor: *evmScriptExecutor
        lidoLocator: *lidoLocator
        trustedCaller: *stVaultsCommittee

    # --- Easy Track factories - Phase 2 (NEW) ---
    etfRegisterGroupsInOperatorGrid:
      name: RegisterGroupsInOperatorGrid
      address: *etfRegisterGroupsInOperatorGrid
      checks:
        DEFAULT_TIER_OPERATOR: *DEFAULT_TIER_OPERATOR
        lidoLocator: *lidoLocator
        trustedCaller: *stVaultsCommittee

    etfUpdateGroupsShareLimitInOperatorGrid:
      name: UpdateGroupsShareLimitInOperatorGrid
      address: *etfUpdateGroupsShareLimitInOperatorGrid
      checks:
        lidoLocator: *lidoLocator
        trustedCaller: *stVaultsCommittee

    etfAlterTiersInOperatorGrid:
      name: AlterTiersInOperatorGrid
      address: *etfAlterTiersInOperatorGrid
      checks:
        lidoLocator: *lidoLocator
        trustedCaller: *stVaultsCommittee

    etfSetJailStatusInOperatorGrid:
      name: SetJailStatusInOperatorGrid
      address: *etfSetJailStatusInOperatorGrid
      checks:
        trustedCaller: *stVaultsCommittee
        vaultsAdapter: *vaultsAdapter

    etfUpdateVaultsFeesInOperatorGrid:
      name: UpdateVaultsFeesInOperatorGrid
      address: *etfUpdateVaultsFeesInOperatorGrid
      checks:
        lidoLocator: *lidoLocator
        trustedCaller: *stVaultsCommittee
        vaultsAdapter: *vaultsAdapter

    etfForceValidatorExitsInVaultHub:
      name: ForceValidatorExitsInVaultHub
      address: *etfForceValidatorExitsInVaultHub
      checks:
        WITHDRAWAL_REQUEST_PREDEPLOY_ADDRESS: *withdrawalRequestPredeployAddress
        trustedCaller: *stVaultsCommittee
        vaultsAdapter: *vaultsAdapter

    etfSocializeBadDebtInVaultHub:
      name: SocializeBadDebtInVaultHub
      address: *etfSocializeBadDebtInVaultHub
      checks:
        trustedCaller: *stVaultsCommittee
        vaultsAdapter: *vaultsAdapter

    etfSetLiabilitySharesTargetInVaultHub:
      name: SetLiabilitySharesTargetInVaultHub
      address: *etfSetLiabilitySharesTargetInVaultHub
      checks:
        trustedCaller: *stVaultsCommittee
        vaultsAdapter: *vaultsAdapter
